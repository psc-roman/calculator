<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>High-Precision Math Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: radial-gradient(circle at top left, #1e293b, #0f172a);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "JetBrains Mono", "Fira Code", monospace;
      }
      .glass {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      }

      #main-display {
        background: transparent;
        border: none;
        outline: none;
        text-align: right;
        width: 100%;
        color: #61ffca;
        font-size: 1.25rem;
        min-height: 1.5rem;
        text-rendering: optimizeSpeed;
        overflow-x: auto;
        white-space: pre;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
      }

      .display-container {
        max-width: 100%;
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        contain: content;
      }

      #history-display {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        direction: rtl;
        text-align: left;
      }

      .calc-button {
        transition: all 0.15s ease;
      }
      .calc-button:hover {
        filter: brightness(1.3);
        transform: translateY(-1px);
      }
      .calc-button:active {
        transform: translateY(1px);
      }

      .placeholder-text {
        color: #94a3b8;
        font-style: italic;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body class="p-4">
    <div
      class="glass w-full max-w-lg rounded-2xl p-6 flex flex-col gap-4 overflow-hidden"
    >
      <div class="flex justify-between items-center mb-2">
        <span class="text-xs font-bold text-slate-500 tracking-widest uppercase"
          >Precision Engine</span
        >
        <div class="flex gap-2">
          <button
            onclick="copyResult()"
            class="text-[10px] text-slate-400 hover:text-white border border-slate-700 px-2 py-1 rounded"
          >
            COPY
          </button>
        </div>
      </div>

      <div
        class="display-container bg-black/40 p-4 rounded-xl border border-white/5"
      >
        <div id="history-display" class="text-slate-500 text-xs h-5 mb-1"></div>
        <div
          id="main-display"
          contenteditable="plaintext-only"
          spellcheck="false"
        >0</div>
      </div>

      <div class="grid grid-cols-4 gap-2">
        <button
          onclick="clearAll()"
          class="calc-button col-span-2 bg-rose-900/40 text-rose-400 py-4 rounded-lg"
        >
          AC
        </button>
        <button
          onclick="appendToken('(')"
          class="calc-button bg-slate-800 text-slate-300 py-4 rounded-lg"
        >
          (
        </button>
        <button
          onclick="appendToken(')')"
          class="calc-button bg-slate-800 text-slate-300 py-4 rounded-lg"
        >
          )
        </button>

        <button
          onclick="appendToken('7')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          7
        </button>
        <button
          onclick="appendToken('8')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          8
        </button>
        <button
          onclick="appendToken('9')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          9
        </button>
        <button
          onclick="appendToken('/')"
          class="calc-button bg-indigo-900/40 text-indigo-400 py-4 rounded-lg"
        >
          ÷
        </button>

        <button
          onclick="appendToken('4')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          4
        </button>
        <button
          onclick="appendToken('5')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          5
        </button>
        <button
          onclick="appendToken('6')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          6
        </button>
        <button
          onclick="appendToken('*')"
          class="calc-button bg-indigo-900/40 text-indigo-400 py-4 rounded-lg"
        >
          ×
        </button>

        <button
          onclick="appendToken('1')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          1
        </button>
        <button
          onclick="appendToken('2')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          2
        </button>
        <button
          onclick="appendToken('3')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          3
        </button>
        <button
          onclick="appendToken('-')"
          class="calc-button bg-indigo-900/40 text-indigo-400 py-4 rounded-lg"
        >
          −
        </button>

        <button
          onclick="appendToken('0')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          0
        </button>
        <button
          onclick="appendToken('.')"
          class="calc-button bg-slate-800/50 text-white py-4 rounded-lg"
        >
          .
        </button>
        <button
          onclick="performCalculation()"
          class="calc-button bg-emerald-900/40 text-emerald-400 py-4 rounded-lg"
        >
          =
        </button>
        <button
          onclick="appendToken('+')"
          class="calc-button bg-indigo-900/40 text-indigo-400 py-4 rounded-lg"
        >
          +
        </button>
      </div>

      <div
        id="status"
        class="text-[10px] text-slate-600 uppercase tracking-tighter"
      >
        System: Stable
      </div>
    </div>

    <script type="module">
      import { calculate } from "https://esm.sh/gh/gameroman/math-parser";

      const mainDisplay = document.getElementById("main-display");
      const historyDisplay = document.getElementById("history-display");
      const statusText = document.getElementById("status");

      let isResultShown = false;
      let expression = ""; // Stores the actual data for the parser
      let isLargeDataStored = false;

      const MAX_LENGTH_THRESHOLD = 200_000;

      window.appendToken = (token) => {
        if (isResultShown || isLargeDataStored) {
          expression =
            !isNaN(token) || token === "(" ? token : expression + token;

          // If it was a large data placeholder, we clear it and show actual text
          // Unless the new appended string is ALSO still over the limit (unlikely for button clicks)
          if (expression.length < MAX_LENGTH_THRESHOLD) {
            mainDisplay.innerText = expression;
            isLargeDataStored = false;
          } else {
            mainDisplay.innerHTML = `<span class="placeholder-text">[Large Expression: ${expression.length} chars]</span>`;
          }

          isResultShown = false;
        } else {
          if (mainDisplay.innerText === "0") {
            mainDisplay.innerText = token;
            expression = token;
          } else {
            mainDisplay.innerText += token;
            expression = mainDisplay.innerText;
          }
        }
        placeCaretAtEnd(mainDisplay);
      };

      window.clearAll = () => {
        mainDisplay.innerText = "0";
        expression = "";
        historyDisplay.innerText = "";
        isResultShown = false;
        isLargeDataStored = false;
        statusText.innerText = "System: Ready";
      };

      window.performCalculation = () => {
        const exp = isLargeDataStored
          ? expression
          : mainDisplay.innerText.trim();
        if (!exp || exp === "0") return;

        statusText.innerText = "Computing...";

        setTimeout(() => {
          try {
            const start = performance.now();
            const result = calculate(exp);
            const end = performance.now();

            historyDisplay.innerText =
              exp.length > MAX_LENGTH_THRESHOLD
                ? `[Large Expression: ${exp.length} chars] =`
                : exp + " =";
            mainDisplay.innerText = result;
            expression = result.toString();
            isResultShown = true;
            isLargeDataStored = false;
            statusText.innerText = `Done in ${(end - start).toFixed(2)}ms`;
          } catch (err) {
            statusText.innerText = "Syntax Error";
          }
        }, 10);
      };

      window.copyResult = () => {
        const text = isLargeDataStored ? expression : mainDisplay.innerText;
        navigator.clipboard.writeText(text).then(() => {
          const originalStatus = statusText.innerText;
          statusText.innerText = "Copied to clipboard";
          setTimeout(() => (statusText.innerText = originalStatus), 2000);
        });
      };

      function placeCaretAtEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }

      mainDisplay.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          performCalculation();
        }
        // If user types while a large data placeholder is shown, clear it
        if (
          isLargeDataStored &&
          !e.ctrlKey &&
          !e.metaKey &&
          e.key.length === 1
        ) {
          mainDisplay.innerText = "";
          expression = "";
          isLargeDataStored = false;
        }
      });

      mainDisplay.addEventListener("paste", (e) => {
        e.preventDefault();
        const text = (e.originalEvent || e).clipboardData.getData("text/plain");

        if (text.length > MAX_LENGTH_THRESHOLD) {
          expression = text;
          isLargeDataStored = true;
          isResultShown = false;
          mainDisplay.innerHTML = `<span class="placeholder-text">[Large Expression: ${text.length} chars]</span>`;
          statusText.innerText = "Large data intercepted - Press = to compute";
        } else {
          const selection = window.getSelection();
          if (!selection.rangeCount) return;
          selection.deleteFromDocument();
          selection.getRangeAt(0).insertNode(document.createTextNode(text));
          selection.collapseToEnd();
          expression = mainDisplay.innerText;
          isLargeDataStored = false;
        }
      });

      mainDisplay.addEventListener("input", () => {
        if (!isLargeDataStored) {
          expression = mainDisplay.innerText;
        }
      });
    </script>
  </body>
</html>
